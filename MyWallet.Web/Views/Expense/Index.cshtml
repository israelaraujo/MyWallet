@model MyWallet.Web.ViewModels.Expense.ListAllExpensesViewModel

<h1 class="h3 mb-2 text-gray-800">Expenses</h1>

<div class="row" style="margin-bottom: 20px">
    <div class="col-md-3">
        <button data-toggle="modal" data-target="#createExpenseModal" class="btn btn-primary btn-icon-split">
            <span class="icon text-white-50">
                <i class="fas fa-plus-circle"></i>
            </span>
            <span class="text">Add Expense</span>
        </button>
    </div>
    <div class="col-md-3">
        @ViewBag.Message
    </div>
</div>

<div class="card shadow mb-4">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="dataTable">
                <thead>
                    <tr>
                        <th>Description</th>
                        <th>Category</th>
                        <th>Bank Account</th>
                        <th>@Model.Currency</th>
                        <th>Paid</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var expense in Model.Expenses)
                    {
                        <tr>
                            <td>@expense.Description</td>
                            <td>@expense.Category</td>
                            <td>@expense.BankAccount</td>
                            <td>@expense.Value</td>
                            <td>@expense.IsPaid</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Form - Add Expense -->
<div class="modal fade" id="createExpenseModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" style="display: none;" aria-hidden="true">
    <div class="modal-dialog modal-md" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">New Expense</h5>
                <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body">
                @using (Html.BeginForm("Create", null, FormMethod.Post, new { @class = "user", id = "formModalCreateExpense" }))
                {
                    <div class="form-group">
                        <input type="text" class="form-control form-control-user" id="description" placeholder="Description">
                    </div>
                    <div class="form-group row">
                        <div class="col-sm-6 mb-3 mb-sm-0">
                            <input type="text" class="form-control form-control-user" id="value" placeholder="Value">
                        </div>
                        <div class="col-sm-6">
                            <input type="text" class="form-control form-control-user" id="date" placeholder="Date">
                        </div>
                    </div>
                    <div class="form-group row">
                        <div class="col-sm-6 mb-3 mb-sm-0">
                            <select class="form-control" id="bankAccount"></select>
                        </div>
                        <div class="col-sm-6">
                            <select class="form-control" id="category"></select>
                        </div>
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
                <button id="btnModalCreateExpense" type="submit" class="btn btn-success btn-icon-split">
                    <span class="icon text-white-50">
                        <i class="fas fa-check"></i>
                    </span>
                    <span class="text">Save</span>
                </button>
            </div>
        </div>
    </div>
</div>

@section scripts{
    <script src="~/vendor/datatables/jquery.dataTables.min.js"></script>
    <script src="~/vendor/datatables/dataTables.bootstrap4.min.js"></script>

    <script>
        $(document).ready(function () {

            loadBankAccountDropDownList();
            loadCategoryDropDownList()

            $('#dataTable').DataTable();

            $('#btnModalCreateExpense').click(function () {

                var expenseJson = {
                    Description: $('#description').val(),
                    Value: $('#value').val(),
                    Date: $('#date').val(),
                    BankAccountId: $('#bankAccount').val(),
                    CategoryId: $('#category').val()
                }

                $.ajax({
                    url: $('#formModalCreateExpense').attr('action'),
                    type: "POST", 
                    data: expenseJson,
                    success: function (data) {
                        alert("Expense added");
                        location.reload();
                    },
                    error: function (error) {
                        alert("Error, check console");
                        console.log(error);
                    }
                });
            });
        });

        function loadBankAccountDropDownList() {
            var url = '@Url.Action("GetAllByContextId", "BankAccount")';
            $.getJSON(url, function (data) {
                //$("#bankAccount").empty();
                $.each(data, function (index, obj) {
                    var $option = $("<option/>");
                    $option.text(obj.Name);
                    $option.val(obj.Id);
                    $("#bankAccount").append($option);
                });
            });
        }

        function loadCategoryDropDownList() {
            var url = '@Url.Action("GetAllByContextId","Category")';
                $.get(url, function (data) {
                    $.each(data, function (index, obj) {
                        var $option = $("<option />");
                        $option.text(obj.Name);
                        $option.val(obj.Id);
                        $("#category").append($option);
                    })
                });
        }
    </script>
}

@section otherCss{
    <link href="~/vendor/datatables/dataTables.bootstrap4.min.css" rel="stylesheet" />
}